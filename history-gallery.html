<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>历史图片画廊</title>
    <link rel="icon" href="resources/icon.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .drawer { transition: transform 0.3s ease-in-out; }
        .drawer-closed { transform: translateX(100%); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen p-4 md:p-8">
    <div class="max-w-7xl mx-auto space-y-6">
        <div class="flex justify-between items-center border-b border-gray-700 pb-4">
            <h1 class="text-2xl font-bold">历史图片画廊</h1>
            <div class="flex space-x-2">
                <button onclick="window.location.href='comfyui-easy-gen.html'" class="text-lg hover:bg-gray-700 p-2 rounded">返回控制台</button>
                <button id="refreshBtn" onclick="refreshHistory()" class="text-lg bg-blue-600 hover:bg-blue-700 p-2 rounded flex items-center">
                    <span>刷新</span>
                    <svg class="w-4 h-4 ml-1 animate-spin hidden" id="refreshIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
                    </svg>
                </button>
            </div>
        </div>

        <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
            <div id="historyGallery" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 animate-fade-in"></div>
        </div>
    </div>

    <div id="fullPreview" class="hidden fixed inset-0 bg-black/95 z-50 flex items-center justify-center p-2 md:p-4">
        <button onclick="closePreview()" class="absolute top-3 right-3 md:top-4 md:right-6 text-3xl md:text-4xl">×</button>
        
        <!-- 上一张按钮 -->
        <button id="prevBtn" onclick="prevImage()" class="absolute left-2 md:left-8 text-4xl md:text-6xl text-white bg-black/50 hover:bg-black/70 p-2 md:p-4 rounded-full transition-opacity opacity-70 hover:opacity-100">
            &lt;
        </button>
        
        <!-- 下一张按钮 -->
        <button id="nextBtn" onclick="nextImage()" class="absolute right-2 md:right-8 text-4xl md:text-6xl text-white bg-black/50 hover:bg-black/70 p-2 md:p-4 rounded-full transition-opacity opacity-70 hover:opacity-100">
            &gt;
        </button>
        
        <img id="previewImg" src="" class="max-h-full max-w-full shadow-2xl">
    </div>

    <!-- Toast通知组件 -->
    <div id="toast" class="fixed top-5 right-5 bg-gray-800 text-white py-3 px-5 rounded-lg shadow-lg transform translate-x-full opacity-0 transition-all duration-300 z-50">
        <div id="toastMessage"></div>
    </div>
</body>
<script>
    // 配置从外部JSON文件加载
    let SERVER;
    
    // 全局状态控制
    let historyImages = [];     // 存储历史图片URL数组
    let historyImageData = [];  // 存储历史图片URL和任务ID的关联信息
    let currentPreviewIndex = 0; // 当前预览图片的索引 
    let currentTaskId = null;   // 当前预览图片的任务ID
    let displayedTaskIds = new Set(); // 跟踪已显示的任务ID，用于优化历史记录加载

    // 初始化时加载配置
    async function initConfig() {
        try {
            // 加载服务器配置
            const configResponse = await fetch('config.json');
            const config = await configResponse.json();
            SERVER = config.SERVER;
            
            // 加载历史记录
            await loadHistory();
        } catch (error) {
            console.error('加载配置文件失败:', error);
            showToast('加载配置失败，请检查服务器是否正常运行');
        }
    }

    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', function() {
        initConfig();
        
        // 添加点击遮罩关闭预览功能
        const fullPreview = document.getElementById('fullPreview');
        fullPreview.addEventListener('click', function(event) {
            // 检查点击的目标是否是遮罩本身（而不是里面的按钮或图片）
            if (event.target === fullPreview) {
                closePreview();
            }
        });
    });

    // 加载历史记录
    async function loadHistory() {
        const res = await fetch(`${SERVER}/history`);
        const data = await res.json();
        const gallery = document.getElementById('historyGallery');
        const newHistoryImages = []; // 存储新的历史图片URL
        const newHistoryImageData = []; // 存储新的历史图片数据

        // 遍历历史记录（倒序，最新的在前面）
        Object.entries(data).reverse().forEach(([taskId, item]) => {
            if(!item.outputs) return;
            for(let nid in item.outputs) {
                item.outputs[nid].images?.forEach(img => {
                    // 【修复点】同样增加 encodeURIComponent
                    const url = `${SERVER}/view?filename=${encodeURIComponent(img.filename)}&subfolder=${encodeURIComponent(img.subfolder)}&type=${img.type}`;

                    // 生成唯一标识，防止重复加载相同图片（包含taskId、节点ID和文件名）
                    const imageKey = `${taskId}-${nid}-${img.filename}`;
                    
                    // 检查图片是否已经显示，如果没有则添加
                    if (!displayedTaskIds.has(imageKey)) {
                        // 标记图片为已显示
                        displayedTaskIds.add(imageKey);
                        
                        // 创建图片容器
                        const imgWrapper = document.createElement('div');
                        imgWrapper.className = "relative w-full mb-2 animate-fade-in";
                        
                        // 创建新的图片元素
                        const i = document.createElement('img');
                        i.src = 'data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=='; // 空白占位图
                        i.setAttribute('data-src', url); // 存储真实图片URL
                        i.loading = 'lazy';
                        i.className = "w-full rounded cursor-pointer border border-gray-600 hover:border-blue-500";
                        i.onclick = () => openPreview(url, taskId);

                        // 当图片进入视口时加载真实图片，离开视口时回收资源
                        const observer = new IntersectionObserver((entries) => {
                            entries.forEach(entry => {
                                const img = entry.target;
                                if (entry.isIntersecting) {
                                    // 图片进入视口，加载真实图片
                                    img.src = img.getAttribute('data-src');
                                } else {
                                    // 图片离开视口，回收资源
                                    img.src = 'data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==';
                                }
                            });
                        }, {
                            // 当图片50%进入视口时触发加载
                            threshold: 0.1
                        });

                        observer.observe(i);
                        
                        // 添加类型标签
                        const isLargeImage = nid === '39' || nid === '42';
                        const labelText = isLargeImage ? '高清大图' : '预览草图';
                        const labelColor = isLargeImage ? 'bg-purple-600' : 'bg-blue-600';
                        
                        const label = document.createElement('span');
                        label.className = `absolute top-2 right-2 ${labelColor} text-white text-xs px-2 py-1 rounded backdrop-blur-sm z-10`;
                        label.textContent = labelText;
                        
                        // 将图片和标签添加到容器
                        imgWrapper.appendChild(i);
                        imgWrapper.appendChild(label);
                        
                        // 将图片添加到画廊
                        gallery.appendChild(imgWrapper);
                        
                        // 将新图片数据存储起来
                        newHistoryImages.unshift(url); // 保持最新的在前面
                        newHistoryImageData.unshift({ url, taskId }); // 保持最新的在前面
                    }
                });
            }
        });

        // 更新历史数组（保持最新的在前面）
        historyImages = [...newHistoryImages, ...historyImages];
        historyImageData = [...newHistoryImageData, ...historyImageData];
    }

    // 刷新历史记录
    async function refreshHistory() {
        // 显示刷新图标
        const refreshIcon = document.getElementById('refreshIcon');
        const refreshBtn = document.getElementById('refreshBtn');
        refreshIcon.classList.remove('hidden');
        refreshBtn.disabled = true;
        
        try {
            // 清空已显示图片键集合和历史数组
            displayedTaskIds.clear();
            historyImages = [];
            historyImageData = [];
            // 清空画廊
            document.getElementById('historyGallery').innerHTML = "";
            // 重新加载所有历史记录
            await loadHistory();
            showToast('历史记录已刷新');
        } catch (error) {
            console.error('刷新历史记录失败:', error);
            showToast('刷新历史记录失败，请重试');
        } finally {
            // 隐藏刷新图标
            refreshIcon.classList.add('hidden');
            refreshBtn.disabled = false;
        }
    }

    // 打开预览
    function openPreview(url, taskId) {
        document.getElementById('previewImg').src = url;
        document.getElementById('fullPreview').classList.remove('hidden');

        // 查找当前图片在历史数组中的索引
        currentPreviewIndex = historyImages.indexOf(url);
        currentTaskId = taskId;

        // 显示导航按钮
        document.getElementById('prevBtn').classList.remove('hidden');
        document.getElementById('nextBtn').classList.remove('hidden');
    }

    // 关闭预览
    function closePreview() {
        document.getElementById('fullPreview').classList.add('hidden');
    }

    // 上一张图片（显示更旧的图片）
    function prevImage() {
        if (currentPreviewIndex >= 0 && currentPreviewIndex < historyImages.length - 1) {
            currentPreviewIndex++;
            document.getElementById('previewImg').src = historyImages[currentPreviewIndex];
            // 更新当前任务ID
            if (historyImageData[currentPreviewIndex]) {
                currentTaskId = historyImageData[currentPreviewIndex].taskId;
            }
        }
    }

    // 下一张图片（显示更新的图片）
    function nextImage() {
        if (currentPreviewIndex > 0) {
            currentPreviewIndex--;
            document.getElementById('previewImg').src = historyImages[currentPreviewIndex];
            // 更新当前任务ID
            if (historyImageData[currentPreviewIndex]) {
                currentTaskId = historyImageData[currentPreviewIndex].taskId;
            }
        }
    }

    // 键盘事件监听
    document.addEventListener('keydown', function(e) {
        // 只有在预览模式打开时才响应键盘事件
        if (!document.getElementById('fullPreview').classList.contains('hidden')) {
            if (e.key === 'ArrowLeft') {
                prevImage(); // 左箭头显示更旧的图片
            } else if (e.key === 'ArrowRight') {
                nextImage(); // 右箭头显示更新的图片
            } else if (e.key === 'Escape') {
                closePreview();
            }
        }
    });

    // Toast通知函数
    function showToast(message, duration = 3000) {
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toastMessage');

        // 设置消息内容
        toastMessage.textContent = message;

        // 显示toast
        toast.classList.remove('translate-x-full', 'opacity-0');
        toast.classList.add('translate-x-0', 'opacity-100');

        // 自动隐藏toast
        setTimeout(() => {
            toast.classList.remove('translate-x-0', 'opacity-100');
            toast.classList.add('translate-x-full', 'opacity-0');
        }, duration);
    }
</script>
</html>